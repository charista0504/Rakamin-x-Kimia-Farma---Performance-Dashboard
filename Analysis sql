SELECT * FROM `Kimia_Farma.kf_final_transaction`LIMIT 10;
SELECT * FROM `Kimia_Farma.kf_product`LIMIT 10;
SELECT * FROM `Kimia_Farma.kf_inventory`LIMIT 10;
SELECT * FROM `Kimia_Farma.kf_kantor_cabang`;

SELECT * FROM `Kimia_Farma.kf_final_transaction` 
WHERE product_id IS NULL 
    OR branch_id IS NULL
    OR date IS NULL 
    OR price IS NULL;

SELECT transaction_id, COUNT(*) AS jumlah
FROM `Kimia_Farma.kf_final_transaction` 
GROUP BY transaction_id
HAVING COUNT(*)>1;

SELECT date, SAFE_CAST(date AS DATE) AS cek_tanggal
FROM Kimia_Farma.kf_final_transaction
LIMIT 20;

SELECT COUNT(DISTINCT product_id)
FROM Kimia_Farma.kf_product;

SELECT COUNT(DISTINCT product_id)
FROM Kimia_Farma.kf_final_transaction;

SELECT COUNT(DISTINCT branch_id)
FROM `Kimia_Farma.kf_kantor_cabang`;

SELECT COUNT(DISTINCT branch_id)
FROM Kimia_Farma.kf_final_transaction;

SELECT 
t.transaction_id,
t.date,
t.customer_name,
t.branch_id,
t.product_id,
p.product_name,
p.product_category,
t.price,
t.discount_percentage,
t.rating AS rating_transaksi,
FROM `Kimia_Farma.kf_final_transaction` t 
LEFT JOIN `Kimia_Farma.kf_product` p 
ON t.product_id=p.product_id;
   
SELECT 
t.transaction_id,
t.date,
t.customer_name,
t.branch_id,
kc.branch_name,
kc.kota,
kc.provinsi,
kc.rating AS rating_cabang,
t.product_id,
p.product_name,
p.product_category,
t.price,
t.discount_percentage,
t.rating AS rating_transaksi,
FROM `Kimia_Farma.kf_final_transaction` t 
LEFT JOIN `Kimia_Farma.kf_product` p 
ON t.product_id=p.product_id
LEFT JOIN Kimia_Farma.kf_kantor_cabang kc
ON t.branch_id=kc.branch_id;

SELECT 
t.transaction_id,
t.date,
t.customer_name,
t.branch_id,
kc.branch_name,
kc.kota,
kc.provinsi,
kc.rating AS rating_cabang,
t.product_id,
p.product_name,
p.product_category,
i.opname_stock,
t.price,
t.discount_percentage,
t.rating AS rating_transaksi,
FROM `Kimia_Farma.kf_final_transaction` t 
LEFT JOIN `Kimia_Farma.kf_product` p 
ON t.product_id=p.product_id
LEFT JOIN Kimia_Farma.kf_kantor_cabang kc
ON t.branch_id=kc.branch_id
LEFT JOIN `Kimia_Farma.kf_inventory` i
ON t.product_id=i.product_id
AND t.branch_id=i.branch_id;

CREATE OR REPLACE TABLE Kimia_Farma.Analysis AS (
SELECT 
t.transaction_id,
t.date,
t.customer_name,
t.branch_id,
kc.branch_name,
kc.kota,
kc.provinsi,
kc.rating AS rating_cabang,
t.product_id,
p.product_name,
p.product_category,
i.opname_stock,
t.price,
t.discount_percentage,
(t.price*t.discount_percentage) AS discount_amount,
(t.price-(t.price*t.discount_percentage)) AS nett_sales,
CASE
    WHEN t.price <= 50000 THEN 0.10
    WHEN t.price > 50000 AND t.price <= 100000 THEN 0.15
    WHEN t.price >100000 AND t.price <= 300000 THEN 0.20
    WHEN t.price > 300000 AND t.price <= 500000 THEN 0.25
    WHEN t.price > 500000 THEN 0.30
END AS persentage_gross_laba,
((t.price-(t.price*t.discount_percentage))*
CASE 
    WHEN t.price <= 50000 THEN 0.10
    WHEN t.price > 50000 AND t.price <= 100000 THEN 0.15
    WHEN t.price >100000 AND t.price <= 300000 THEN 0.20
    WHEN t.price > 300000 AND t.price <= 500000 THEN 0.25
    WHEN t.price > 500000 THEN 0.30
END 
) AS nett_profit,
t.rating AS rating_transaksi, 
FROM `Kimia_Farma.kf_final_transaction` t 
LEFT JOIN `Kimia_Farma.kf_product` p 
ON t.product_id=p.product_id
LEFT JOIN Kimia_Farma.kf_kantor_cabang kc
ON t.branch_id=kc.branch_id
LEFT JOIN `Kimia_Farma.kf_inventory` i
ON t.product_id=i.product_id
AND t.branch_id=i.branch_id
);

SELECT
    COUNT(*) AS total_transacion,
    MIN(date) AS earliest_date,
    MAX(date) AS latest_date,
    AVG(price) AS average_price,
    AVG(discount_percentage) AS average_discount_percentage,
    SUM(nett_sales) AS total_net_sales,
    SUM(nett_profit) AS total_net_profit,
    AVG(rating_transaksi) AS average_transaction_rating,
    AVG(rating_cabang) AS average_branch_rating,
    branch_name,
    COUNT(DISTINCT customer_name) AS total_customers,
FROM `Kimia_Farma.Analysis`
GROUP BY branch_name
ORDER BY total_net_sales DESC;

select count(distinct branch_name) AS total_branch FROM Kimia_Farma.Analysis;

Select * FROM Kimia_Farma.Analysis;
